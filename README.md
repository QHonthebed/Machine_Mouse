# Machine_Mouse
SASU
**机器鼠控制部分调试说明**

**赛曙科技有限公司**

机器鼠控制部分的代码主要存在于sensor.c和Action.c两个文件中，分别编写了传感器采集部分和运动控制部分。

使用者在进行调试时首先需要标定传感器阈值。将示例程序烧录到单片机后，可选择使用Keil集成编译环境中的在线调试功能，或使用第三方参数监控与调试软件（如FreeMaster）对一些全局变量进行实时监控，以确定传感器的阈值等信息。传感器数值的检测分别写在了sensor.c文件中的Get\_Sensor\_LR、Get\_Sensor\_FLR、Get\_Sensor\_LRA函数中。

*   将机器鼠正向放置于赛道中央，保持和赛道两边距离相等，此时记录下Infrared结构体中的Ad\_RightOblique和Infrared.Ad\_LeftOblique变量的数值，并将sensor.c文件上半部分的u16 LeftOblique\_Has\_Wall和u16 RightOblique\_Has\_Wall变量的值更改为对应的数值，以确定左前方和右前方有无墙壁（障碍）的判断阈值。此数值将决定机器鼠在运行过程中是否可以处于赛道的正中央，通过Action.c文件中的PoseCor函数实现对机器鼠直线运行过程中的姿态矫正，使得机器鼠保持在赛道正中央平稳运行。
*    将机器鼠放置在赛道尽头，保证其前方具有墙壁（障碍物）。机器鼠几何中心位置距障碍物的距离可根据预设定的速度进行调整，通常情况下机器鼠集合中心距前方障碍物的距离为75格时记录下的传感器数值较为适宜，此数值在无阳光干扰的调试环境中参考范围约为100~500左右。此时观察Infrared结体中的Infrared.Ad\_FrontLeft和Infrared.Ad\_FrontRight变量并记录，并将sensor.c文件上半部分的u16 FrontLeft\_Has\_Wall和u16 FrontRight\_Has\_Wall变量更改为对应的数值，以确定前方有无墙壁（障碍）的判断阈值。此数值将确定机器鼠运行到某一格后判断前方是否有障碍物的判断依据，若经常发生误判，可适当将阈值标定时机器鼠距离墙壁的距离调远，以减小此数值。
*    将电脑鼠放置在左侧或右侧无墙壁（障碍）的位置，进行对侧面传感器阈值的标定。首先使机器鼠几何中心距离左侧墙壁（障碍物）75格左右，记录下此时Infrared结构体中Infrared.Ad\_Left的数值，同样使机器鼠几何中心距离右侧墙壁（障碍物）0.75格左右，记录下此时Infrared.Ad\_Right的数值。此数值在无阳光干扰的调试环境中参考范围约为100~400左右，若因传感器焊接等问题有超出此参考范围的数值也属于正常情况。将对应数值幅值给sensor.c文件上半部分的u16 Left\_Has\_Wall和u16 Right\_Has\_Wall，此数值将确定机器鼠运行到某一格后判断左右侧是否有障碍物的判断依据。

接下来进行运动状态的细节调试，该部分代码存在于Action.c文件中。首先在mian.c函数中将Debug变量置为1，进入调试模式。调用MouseGoAhead(1 * ONE\_BLOCK\_STEP);函数并配合MouseStop();使用，测试机器鼠前行一步的指令是否行走了恰好一格，若有偏差，则调整Action.c文件中的ONE\_BLOCK\_STEP变量，使得机器鼠在此调试命令下正好前进一格的距离。该数值为机器鼠自认为前进一格编码器计数值，出厂设置为21800左右，会因轮胎尺寸，赛道摩擦程度等原因进行微调。接下来调整转向参数，配合在main.c文件中调用MouseTurnLeft();MouseTurnRight();MouseTurnBack;等函数，调整Action.c文件中的TURN\_LEFT\_COUNTER、TURN\_RIGHT\_COUNTER、TURN\_BACK\_COUNTER等变量的数值，使得机器鼠进行精确的转向角度。此后调整Action.c文件中的STEP\_CORRECT变量数值，使得机器鼠转向之后的前进操作恰好也是一格的步长。该数值为步数矫正值，补偿因旋转中心于机器鼠几何中心偏差所造成的机器鼠转向后的轻微移位，再接下来的前进计步函数中减去一定的数值。此外可对Action.c文件中的POSE\_CORRECT、SUPURTPOSE_CORRECT变量进行微调，改变机器鼠直行过程中姿态矫正动作的修正力度，该数值越大，姿态修正越为明显。

此后进行机器鼠速度调整。通过调整Action.c文件中的MAX\_SPEED\_IN\_SEARCH、MAX\_SPEED\_IN\_SPURT、Basic\_Speed\_In\_Search、Basic\_Speed\_In\_Spurt、TLeft\_left\_speed、TLeft\_right\_speed等变量实现对机器鼠最大搜索速度，最大冲刺速度，基准搜索速度，基准冲刺速度，转向速度等的调节。

上述调节步骤是机器鼠准确在迷宫中进行搜索的先决条件，请按照步骤调整，尽量准确。调节与标定工作完成后，若机器鼠结构及调试场地环境无明显变化，则无需再次调整。此时应将main.c函数中的Debug变量置0，进入正常搜索迷宫的程序。正常搜索迷宫时请将机器数放置于迷宫起点，之后复位并打开电机开关，机器鼠即可自动搜索迷宫并返回起点，之后进行最短路径的冲刺。

本例程算法部分采用A*算法进行最优路径规划示例，此外，使用者还可修改Maze中的相关函数，加入不同的搜索算法。
